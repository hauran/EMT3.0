{{#data}}
<!-- <div class='nav-bg'></div> -->
<div id='mainContent' class='fill-parent'>
  <div class="row-fluid navbar">
    <div class='menu-width'>
      {{#me}}
        <ul class="nav nav-pills">
          <li>
            <a class="btn btn-navbar pull-left">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
          </li>
          <li class='new-favor phone hide'>
            <form class="navbar-form">
              <input type="text" class='request' name='request' placeholder='ask your friends for a favor...'>
            </form>
          </li>

          <li class='username'>
            <a href="#">
              {{username}} <i class='icon-caret-down'/>
            </a>
            <ul class='downdown'>
              <li>
                  <a class='logout' href="/logout"><i class='icon-signout'/> Logout</a>
              </li>
            </ul> 
          </li>
        </ul>
      {{/me}}
    </div>
    <div class='rest-of-space'>
      <ul class="nav nav-pills">
        <li class='new-favor desktop'>
          <form class="navbar-form">
            <input type="text" class='request' name='request' placeholder='ask your friends for a favor...'>
          </form>
        </li>
      </ul>
    </div>
  </div>
  <div class='row-fluid fill-parent clear'>
    <div id='leftBar' class='menu-width'>
        {{#me}}
          <div class="navbar phone hide">
            <ul class="nav nav-pills">
              <li class='username'>
                <a href="#">
                  {{username}} <i class='icon-caret-down'/>
                </a>
                <ul class='downdown'>
                  <li>
                      <a class='logout' href="/logout"><i class='icon-signout'/> Logout</a>
                  </li>
                </ul> 
              </li>
            </ul>
          </div>
        {{/me}}
        <div id='leftBarScrollContainer'>
          {{#me}}
            <div id='icon'>
              {{^picture}}
                <i class='icon-user'/>
              {{/picture}}
              {{#picture}}
                <img src='http://graph.facebook.com/{{FBid}}/picture?type=large'/>
              {{/picture}}
              {{#stats}}
              <div class='stats'>
                <div class='stat'>
                  {{count}}
                  <div class='category'>posts</div>
                </div>
                <div class='stat'>
                  2
                  <div class='category'>owe</div>
                </div> 
                <div class='stat'>
                  3
                  <div class='category'>owed</div>
                </div>
              </div>
              {{/stats}}
            </div>
            <div class='subtitle'>
              friends <small class='mute'>({{following_count}})</small>
              <i class='icon-plus add-friend'/>
            </div>
            <div class='friend-search collapse'>
                <form class="addFriend-form">
                  <input type="text" id='addFriend' class="input-block-level" placeholder="@friend or email">
                </form>
            </div>
          {{/me}}
          <div id='friend-listing-container'>
            <ul class='friend-listing'>
              {{#following}}
                {{> person_listing}}
              {{/following}}
            </ul>
          </div>
        </div>
        <div class='left-content-modal content-modal'></div>
    </div>
    
    <div id='rightContent' class='rest-of-space fill-parent'>
      {{#posts}}
        {{> posts}}
      {{/posts}}
    </div>
  </div>
  <div class='right-content-modal content-modal'></div>
</div>


<script>
  RSPY.meId = "{{me._id}}";
  RSPY.meEmail = "{{me.email}}";
  socketio_connect();
  $('hr').first().remove();
  $('.modal-backdrop').remove();

  $('.navbar-form').on('submit',function(e){
    e.preventDefault();
    var request = $(".new-favor:visible .request").val().trim();
    if(request!='') {
      RSPY.post('/post/new_post', {post:request}, function(data){
        RSPY.newPost(data.payload.data.new_post[0]);
        $("#request").val('');
      });
    }
  });


  hammertime.on("tap", ".navbar li.username a", function(ev) {
    console.log('nav', this)
     $(this).siblings('.downdown').toggleClass('show');
      ev.stopPropagation();
  });

  hammertime.on("tap", ".add-friend", function(ev) {
      $('.friend-search').collapse('toggle');
      ev.stopPropagation();
  });

  $('.friend-search').on('shown',function(){
    $(this).find('input').focus();
  });


  $('.addFriend-form').on('submit',function(e){
    e.preventDefault();
    var addFriend = $("#addFriend").val();
    RSPY.post('/post/add_friend', {addFriend:addFriend}, function(data){
      $('#addFriend').val('');
      newPerson = data.payload.data.add_friend;
      if(newPerson._id) {
        $('.friend-search').collapse('hide');
        RSPY.newPersonListing(newPerson);
        RSPY.getPosts();
      }
    });
  });

  // content modals for iphone auto focusing nav dropdown and search field
  hammertime.on("tap", ".btn-navbar", function(ev) {
      $('#mainContent').toggleClass('menu-in');
      $('#leftBar').toggleClass('menu-in');
      $('.content-modal').show();
      setTimeout(function(){$('.left-content-modal').hide();},500);
      $('#leftBarScrollContainer').height($(window).height() - $('#leftBarScrollContainer').offset().top);
      ev.stopPropagation();
  });


  hammertime.on("tap", ".right-content-modal", function(ev) {
      $('#mainContent').toggleClass('menu-in');
      $('#leftBar').toggleClass('menu-in');
      setTimeout(function(){$('.right-content-modal').hide();},500);
      ev.stopPropagation();
  });

  $('#rightContent').masonry({
    itemSelector : '.post',
    easing: 'linear',
    gutterWidth:10
  });
  $('.time-ago').timeago();


  setTimeout(function(){
    $('#rightContent').masonry('reload').addClass('show');
    RSPY.redoLayout();
  },1000);

</script>


{{/data}}
